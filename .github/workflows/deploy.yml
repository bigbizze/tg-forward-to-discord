# GitHub Actions Deployment Workflow
#
# This workflow deploys the application to Hetzner Cloud when code is pushed
# to the master branch. It SSHs into the server and runs the idempotent setup
# script.
#
# Required Secrets (configure in GitHub repo settings):
# - SSH_HOST: Server IP address (get from: pulumi stack output serverIp)
# - SSH_PRIVATE_KEY: SSH private key (get from: pulumi stack output sshPrivateKey --show-secrets)
# - GH_TOKEN: GitHub Personal Access Token with repo scope (for private repo access)
# - ENV_FILE: Complete .env file content with all application configuration
#
# The server is provisioned by Pulumi with cloud-init which installs:
# - Node.js v22, Python 3, pnpm, PM2
# - Creates /opt/tg-discord directory
# - Sets up PM2 systemd service
#
# This workflow will:
# 1. Clone/update the repository on the server
# 2. Create .env file from GitHub secret
# 3. Install dependencies (Node.js and Python)
# 4. Build all TypeScript packages
# 5. Set up the database
# 6. Start/restart PM2 processes

name: Deploy

on:
  push:
    branches:
      - master
      - main
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add Remote Host to Known Hosts
        run: |
          echo "Adding host to known_hosts..."
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          echo "✓ Host added successfully"
      
      - name: Deploy to Server
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
        run: |
          ssh root@${{ secrets.SSH_HOST }} "GH_TOKEN='${GH_TOKEN}' GITHUB_REPOSITORY='${GITHUB_REPOSITORY}' GITHUB_REF_NAME='${GITHUB_REF_NAME}' SSH_HOST='${SSH_HOST}' ENV_FILE='${ENV_FILE}' bash -s" << 'ENDSSH'
          set -e
          
          echo "=== Starting deployment ==="
          echo "Server: $(hostname)"
          echo "User: $(whoami)"
          echo "Date: $(date)"
          echo ""
          
          # Verify required environment variables are set
          if [ -z "$GH_TOKEN" ]; then
            echo "ERROR: GH_TOKEN not set"
            exit 1
          fi
          
          if [ -z "$GITHUB_REPOSITORY" ]; then
            echo "ERROR: GITHUB_REPOSITORY not set"
            exit 1
          fi
          
          if [ -z "$GITHUB_REF_NAME" ]; then
            echo "ERROR: GITHUB_REF_NAME not set"
            exit 1
          fi
          
          # Ensure project directory exists
          mkdir -p /opt/tg-discord
          cd /opt/tg-discord
          
          # Check if git repository is initialized
          if [ ! -d ".git" ]; then
            echo "=== First deployment detected ==="
            echo "Initializing git repository..."
            
            # Check if directory has files (besides .cloud-init-complete)
            FILE_COUNT=$(find . -maxdepth 1 -not -name '.cloud-init-complete' -not -name '.' -not -name '..' 2>/dev/null | wc -l)
            
            if [ "$FILE_COUNT" -gt 0 ]; then
              echo "Directory not empty, cleaning up non-critical files..."
              find . -maxdepth 1 -not -name '.cloud-init-complete' -not -name '.' -not -name '..' -exec rm -rf {} + 2>/dev/null || true
            fi
            
            # Initialize git and fetch using token authentication
            echo "Initializing git..."
            git init
            
            echo "Adding remote..."
            git remote add origin "https://${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
            
            echo "Fetching from origin..."
            git fetch origin
            
            echo "Checking out branch ${GITHUB_REF_NAME}..."
            git checkout -b "${GITHUB_REF_NAME}"
            
            echo "Resetting to origin/${GITHUB_REF_NAME}..."
            git reset --hard "origin/${GITHUB_REF_NAME}"
            
            echo "✓ Repository cloned successfully"
          else
            echo "=== Updating existing deployment ==="
          fi
          
          # Update the remote URL with token (in case it was set without token initially)
          echo "Updating remote URL with authentication token..."
          git remote set-url origin "https://${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          
          # Fetch and reset to latest
          echo "Fetching latest code..."
          git fetch origin
          
          # Store old commit for comparison
          OLD_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "none")
          
          # Reset to latest
          git reset --hard "origin/${GITHUB_REF_NAME}"
          
          # Show what changed
          NEW_COMMIT=$(git rev-parse HEAD)
          echo ""
          echo "Commit: $(git rev-parse --short HEAD)"
          
          if [ "$OLD_COMMIT" != "$NEW_COMMIT" ] && [ "$OLD_COMMIT" != "none" ]; then
            echo "Changes:"
            git log --oneline --no-decorate "$OLD_COMMIT..$NEW_COMMIT" 2>/dev/null || echo "  (showing latest commit only)"
          fi
          
          echo "Latest commit message:"
          git log -1 --pretty=format:"%s"
          echo ""
          echo ""
          
          # Create .env file from GitHub secret
          if [ -n "$ENV_FILE" ]; then
            echo "Creating .env file from GitHub secret..."
            echo "$ENV_FILE" > .env
            chmod 600 .env  # Secure the .env file
            echo "✓ .env file created and secured"
          else
            echo "⚠️  WARNING: ENV_FILE secret not set!"
            echo "The application may not start without proper configuration."
            echo ""
            echo "To fix this:"
            echo "1. Go to GitHub repository → Settings → Secrets and variables → Actions"
            echo "2. Add a new secret named 'ENV_FILE' with your .env content"
            echo "3. Re-run this deployment"
            echo ""
          fi
          
          # Run the idempotent setup script
          echo "Running setup script..."
          chmod +x scripts/idempotent-setup.sh
          ./scripts/idempotent-setup.sh
          
          echo ""
          echo "=== Deployment complete ==="
          echo ""
          echo "View logs with: pm2 logs"
          echo "Check status with: pm2 status"
          ENDSSH

      - name: Deployment Summary
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo ""
          echo "Server: ${{ secrets.SSH_HOST }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "View application logs:"
          echo "  ssh -i ssh_key root@${{ secrets.SSH_HOST }} 'pm2 logs'"
          echo ""
          echo "Check PM2 status:"
          echo "  ssh -i ssh_key root@${{ secrets.SSH_HOST }} 'pm2 status'"

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          echo ""
          echo "Troubleshooting steps:"
          echo "1. Check the logs above for error details"
          echo "2. SSH into server: ssh -i ssh_key root@${{ secrets.SSH_HOST }}"
          echo "3. Check PM2 logs: pm2 logs"
          echo "4. Check PM2 status: pm2 status"
          echo "5. Manual restart: cd /opt/tg-discord && ./scripts/idempotent-setup.sh"
          echo ""
          echo "Common issues:"
          echo "- Missing ENV_FILE secret: Add it in GitHub Settings → Secrets"
          echo "- Missing GH_TOKEN secret: Create a Personal Access Token with repo scope"
          echo "- SSH connection issues: Verify SSH_HOST and SSH_PRIVATE_KEY secrets"
          exit 1
