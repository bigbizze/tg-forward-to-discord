<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PM2 Logs Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    #login-box {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
    }

    #login-box h1 {
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }

    #login-box input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      margin-bottom: 15px;
      font-family: monospace;
    }

    #login-box button {
      width: 100%;
      padding: 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }

    #login-box button:hover {
      background: #5568d3;
    }

    #login-box .error {
      color: #e74c3c;
      margin-top: 10px;
      text-align: center;
      font-size: 14px;
    }

    #dashboard {
      display: none;
      flex-direction: column;
      height: 100vh;
    }

    #header {
      background: #252526;
      padding: 15px 20px;
      border-bottom: 1px solid #3e3e42;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #header h1 {
      font-size: 18px;
      color: #d4d4d4;
    }

    #controls {
      display: flex;
      gap: 10px;
    }

    button {
      padding: 8px 16px;
      background: #0e639c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background: #1177bb;
    }

    button.danger {
      background: #c72e0c;
    }

    button.danger:hover {
      background: #e81123;
    }

    #status {
      padding: 10px 20px;
      background: #2d2d30;
      border-bottom: 1px solid #3e3e42;
      font-size: 14px;
    }

    #status.connected {
      background: #1e3a20;
      color: #4ec9b0;
    }

    #status.disconnected {
      background: #3a1e1e;
      color: #f48771;
    }

    #logs-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #1e1e1e;
    }

    .log-line {
      padding: 4px 0;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* Process name colors */
    .process-name { font-weight: bold; }
    .process-0 { color: #569cd6; } /* Blue */
    .process-1 { color: #4ec9b0; } /* Teal */
    .process-2 { color: #c586c0; } /* Purple */
    .process-3 { color: #ce9178; } /* Orange */
    .process-4 { color: #dcdcaa; } /* Yellow */
    .process-5 { color: #9cdcfe; } /* Light blue */

    /* Datetime styling */
    .log-datetime { color: #4a4a4a; }

    /* Log message styling */
    .log-message { color: #b0b0b0; }

    /* ANSI color classes */
    .ansi-black { color: #000000; }
    .ansi-red { color: #cd3131; }
    .ansi-green { color: #0dbc79; }
    .ansi-yellow { color: #e5e510; }
    .ansi-blue { color: #2472c8; }
    .ansi-magenta { color: #bc3fbc; }
    .ansi-cyan { color: #11a8cd; }
    .ansi-white { color: #e5e5e5; }
    .ansi-bright-black { color: #666666; }
    .ansi-bright-red { color: #f14c4c; }
    .ansi-bright-green { color: #23d18b; }
    .ansi-bright-yellow { color: #f5f543; }
    .ansi-bright-blue { color: #3b8eea; }
    .ansi-bright-magenta { color: #d670d6; }
    .ansi-bright-cyan { color: #29b8db; }
    .ansi-bright-white { color: #e5e5e5; }
    .ansi-bold { font-weight: bold; }
    .ansi-dim { opacity: 0.5; }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-container">
    <div id="login-box">
      <h1>ðŸ”’ PM2 Logs</h1>
      <form id="login-form">
        <input
          type="password"
          id="token-input"
          placeholder="Enter access token"
          autocomplete="off"
          required
        />
        <button type="submit">Access Logs</button>
        <div id="login-error" class="error"></div>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard">
    <div id="header">
      <h1>ðŸ“Š PM2 Live Logs</h1>
      <div id="controls">
        <button id="clear-btn">Clear</button>
        <button id="scroll-btn">Auto-scroll: ON</button>
        <button id="logout-btn" class="danger">Logout</button>
      </div>
    </div>
    <div id="status" class="disconnected">Disconnected</div>
    <div id="logs-container"></div>
  </div>

  <script>
    const TOKEN_KEY = 'pm2_log_viewer_token';
    let eventSource = null;
    let autoScroll = true;

    // Check for existing token
    const savedToken = localStorage.getItem(TOKEN_KEY);
    if (savedToken) {
      connectToLogs(savedToken);
    }

    // Login form handler
    document.getElementById('login-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const token = document.getElementById('token-input').value.trim();
      if (token) {
        localStorage.setItem(TOKEN_KEY, token);
        connectToLogs(token);
      }
    });

    // Connect to SSE stream
    function connectToLogs(token) {
      document.getElementById('login-container').style.display = 'none';
      document.getElementById('dashboard').style.display = 'flex';

      const statusEl = document.getElementById('status');
      statusEl.textContent = 'Connecting...';
      statusEl.className = 'disconnected';

      eventSource = new EventSource(`/api/stream?token=${encodeURIComponent(token)}`);

      eventSource.onopen = () => {
        statusEl.textContent = 'âœ“ Connected';
        statusEl.className = 'connected';
      };

      eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'log' || data.type === 'error') {
          addLogLine(data.data);
        } else if (data.type === 'connected') {
          console.log(data.message);
        } else if (data.type === 'disconnect') {
          statusEl.textContent = 'âœ— Disconnected';
          statusEl.className = 'disconnected';
        }
      };

      eventSource.onerror = (error) => {
        console.error('SSE Error:', error);
        statusEl.textContent = 'âœ— Connection Error';
        statusEl.className = 'disconnected';

        // If 401, show login again
        if (error.target.readyState === EventSource.CLOSED) {
          setTimeout(() => {
            document.getElementById('login-error').textContent = 'Invalid token or connection lost';
            logout();
          }, 1000);
        }
      };
    }

    // Add log line with custom formatting
    function addLogLine(text) {
      const formatted = formatLogLine(text);

      // Skip empty/blank lines
      if (formatted === null) {
        return;
      }

      const container = document.getElementById('logs-container');
      const line = document.createElement('div');
      line.className = 'log-line';
      line.innerHTML = formatted;
      container.appendChild(line);

      // Auto-scroll
      if (autoScroll) {
        container.scrollTop = container.scrollHeight;
      }

      // Limit to 1000 lines
      while (container.children.length > 1000) {
        container.removeChild(container.firstChild);
      }
    }

    // Process name to color class mapping
    const processColors = {};
    let nextColorIndex = 0;

    function getProcessColorClass(processName) {
      if (!processColors[processName]) {
        processColors[processName] = nextColorIndex % 6;
        nextColorIndex++;
      }
      return `process-${processColors[processName]}`;
    }

    // Strip all ANSI escape codes
    function stripAnsi(text) {
      return text.replace(/\x1b\[[0-9;]*m/g, '');
    }

    // Parse and format PM2 log line
    // Returns null if the line should be skipped (empty message)
    function formatLogLine(text) {
      const escapeHtml = (str) => str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      // Strip all ANSI codes first
      const cleanText = stripAnsi(text);

      // Skip lines that are just the process prefix with no content (e.g., "0|express- | ")
      if (/^\d+\|[^\|]+\s*\|\s*$/.test(cleanText)) {
        return null;
      }

      // Parse PM2 log format: "0|process-name | 2025-12-09T00:42:10: message"
      const pm2Match = cleanText.match(/^(\d+\|[^\|]+)\s*\|\s*(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}):\s*(.*)$/);

      if (pm2Match) {
        const [, processInfo, datetime, message] = pm2Match;
        const processName = processInfo.trim();
        const colorClass = getProcessColorClass(processName);

        // Skip lines with empty messages
        if (!message || !message.trim()) {
          return null;
        }

        return `<span class="log-datetime">${escapeHtml(datetime)}</span> <span class="process-name ${colorClass}">${escapeHtml(processName)}</span> :: <span class="log-message">${escapeHtml(message)}</span>`;
      }

      // Handle standalone datetime lines (continuation from PM2 split): "2025-12-09T00:42:10: message"
      const standaloneMatch = cleanText.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}):\s*(.*)$/);
      if (standaloneMatch) {
        const [, datetime, message] = standaloneMatch;

        if (!message || !message.trim()) {
          return null;
        }

        return `<span class="log-datetime">${escapeHtml(datetime)}</span> <span class="process-name process-0">unknown</span> :: <span class="log-message">${escapeHtml(message)}</span>`;
      }

      // Fallback: skip if empty, otherwise show as log message
      if (!cleanText.trim()) {
        return null;
      }
      return `<span class="log-message">${escapeHtml(cleanText)}</span>`;
    }

    // Clear logs
    document.getElementById('clear-btn').addEventListener('click', () => {
      document.getElementById('logs-container').innerHTML = '';
    });

    // Toggle auto-scroll
    document.getElementById('scroll-btn').addEventListener('click', (e) => {
      autoScroll = !autoScroll;
      e.target.textContent = `Auto-scroll: ${autoScroll ? 'ON' : 'OFF'}`;
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', logout);

    function logout() {
      if (eventSource) {
        eventSource.close();
      }
      localStorage.removeItem(TOKEN_KEY);
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('login-container').style.display = 'flex';
      document.getElementById('token-input').value = '';
      document.getElementById('logs-container').innerHTML = '';
    }
  </script>
</body>
</html>